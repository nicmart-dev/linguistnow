# Development Principles

## Core Principles

1. **API First**: Define types, interfaces, and API contracts before implementation
2. **TDD**: Write failing tests first, then implement to make them pass
3. **DRY**: Extract reusable code into shared modules
4. **Modular**: Keep services, controllers, and utilities in separate files
5. **Docs as Code**: Update documentation alongside implementation

## Development Workflow

1. Define types in `shared/` package (API contract)
2. Write failing tests (TDD red phase)
3. Implement to make tests pass (TDD green phase)
4. Refactor if needed (TDD refactor phase)
5. Update docs and Swagger alongside code changes

## Code Organization

| Path                       | Purpose                                    |
| -------------------------- | ------------------------------------------ |
| `shared/src/`              | Types shared between client and server     |
| `server/services/`         | Business logic (testable, reusable)        |
| `server/controllers/`      | HTTP request/response handling             |
| `server/routes/`           | Route definitions with Swagger docs        |
| `client/src/components/`   | React components                           |
| `client/src/i18n/locales/` | Internationalization strings               |
| `docs/`                    | Architecture and integration documentation |

## Documentation Standards

- Use **Mermaid diagrams** for visual representations (`graph`, `flowchart`, `sequenceDiagram`, `classDiagram`)
- Prefer Mermaid over ASCII art for better maintainability

## Internationalization (i18n)

- **All user-facing strings** → `client/src/i18n/locales/*.json`
- **New strings must be added to ALL locales**: en, fr, es, de, it, pt, zh-cn, ja, ko, ar, ru
- Pattern: `section.subsection.key` (e.g., `dashboard.errors.vaultError`)
- Pluralization: `_one` and `_other` suffixes
- Interpolation: `{{variable}}` syntax

---

## Security Best Practices

**CRITICAL**: All user input must be validated before use. CodeQL flags unvalidated input.

### Input Validation Rules

| Rule                             | Implementation                                         |
| -------------------------------- | ------------------------------------------------------ |
| Validate `req.body/query/params` | Check type, format, bounds before use                  |
| Type validation                  | Validate before `.split()`, `.includes()`, `.map()`    |
| ReDoS prevention                 | Limit input length before regex (email: max 254 chars) |
| Format string injection          | Replace `%` with `%%` in user input for logs           |
| Path traversal                   | Reject paths containing `..`, `/`, `\`                 |
| Formula injection                | Escape `'` → `''` for Airtable formulas                |

### Code Examples

```typescript
// ✅ Request validation
const { code } = req.body;
if (!code || typeof code !== "string" || code.trim().length === 0) {
  return res.status(400).json({ error: "Invalid authorization code" });
}

// ✅ Type validation before string operations
if (typeof startDate !== "string")
  throw new Error("startDate must be a string");
const parts = startDate.split("-").map(Number);

// ✅ Length check before regex (ReDoS prevention)
if (email.trim().length > 254) return false;
return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());

// ✅ Path traversal prevention
if (
  userEmail.includes("..") ||
  userEmail.includes("/") ||
  userEmail.includes("\\")
) {
  throw new Error("Invalid email: path traversal characters");
}

// ✅ Airtable formula escaping
const escapedEmail = userEmail.replace(/'/g, "''");
const formula = `{Email} = '${escapedEmail}'`;
```

### CodeQL Alert Quick Fixes

| Alert                                      | Fix                             |
| ------------------------------------------ | ------------------------------- |
| Type confusion through parameter tampering | Validate type before operations |
| Polynomial regex on uncontrolled data      | Add length limit before regex   |
| Externally-controlled format string        | Sanitize `%` in log messages    |
| Path traversal                             | Validate and sanitize paths     |
| Unvalidated user input                     | Validate all request inputs     |

### Security Checklist

- [ ] `req.body/query/params` validated (type, format, bounds)
- [ ] String operations preceded by type checks
- [ ] Regex matching preceded by length limits
- [ ] User input sanitized in log messages
- [ ] File paths validated for traversal
- [ ] Database/formula strings escaped

---

# Commit Message Guidelines

Follow [Conventional Commits](https://www.conventionalcommits.org/). See [CONTRIBUTING.md](./CONTRIBUTING.md) for details.

## Semantic Release: Choose the Right Type

Ask: **"Will a user notice this change?"**

### Release-Triggering Types (User-Facing)

| Type   | When to Use                          | Release       |
| ------ | ------------------------------------ | ------------- |
| `feat` | New user-facing functionality        | Minor (1.x.0) |
| `fix`  | Bug fix users can observe            | Patch (1.0.x) |
| `perf` | Performance improvement users notice | Patch (1.0.x) |

### Non-Release Types (Internal)

| Type       | When to Use                             |
| ---------- | --------------------------------------- |
| `ci`       | CI/CD, GitHub Actions, workflows        |
| `build`    | Build system, dependencies, Docker      |
| `chore`    | Maintenance, config updates             |
| `docs`     | Documentation changes                   |
| `refactor` | Code restructuring (no behavior change) |
| `test`     | Adding or updating tests                |
| `style`    | Formatting, whitespace                  |

### Decision Guide

```
CI/GitHub Actions change?     → ci:        (not fix(ci):)
Build/Docker/deps change?     → build:     (not fix(build):)
User-visible bug fix?         → fix:       ✅ triggers release
User-facing new feature?      → feat:      ✅ triggers release
```

### Scopes

| Scope    | Description             |
| -------- | ----------------------- |
| `client` | Frontend React app      |
| `server` | Backend Express API     |
| `shared` | Shared types package    |
| `docker` | Docker configuration    |
| `deps`   | Production dependencies |

### Breaking Changes

```bash
feat(server)!: remove deprecated /api/v1 endpoints

# or use footer:
BREAKING CHANGE: OAuth tokens now use JWT format.
```

## Commit Organization: Bundle by Feature

**CRITICAL**: One commit = one complete feature (code + tests + docs + i18n)

✅ **DO**: Bundle all related changes together

```bash
feat(client): add currency support with multi-currency display
# Includes: utility, tests, docs, i18n strings, shared types
```

❌ **DON'T**: Split by file type

```bash
# Wrong: separate commits for feat/test/docs/i18n
feat(client): add currency utility
test(client): add currency tests
docs: add currency documentation
```

### When to Split Commits

1. **Different features** → separate commits
2. **Unrelated changes** → config/build separate from features
3. **Large refactors** → separate from new features
