# Development Principles

## Tech Stack

| Layer      | Technology                                                     |
| ---------- | -------------------------------------------------------------- |
| Frontend   | React 19, TypeScript 5, Tailwind CSS 4, Vite 7, React Router 7 |
| Backend    | Express 5, TypeScript 5, tsx (runtime)                         |
| UI         | Radix UI primitives, shadcn/ui patterns, Lucide icons          |
| Validation | Zod 4 (client + server)                                        |
| Testing    | Vitest 4, React Testing Library, happy-dom                     |
| API Docs   | Swagger/OpenAPI via swagger-jsdoc                              |
| Database   | Airtable (REST API)                                            |
| Auth       | Google OAuth 2.0                                               |
| Secrets    | HashiCorp Vault                                                |
| Monorepo   | pnpm workspaces                                                |

## Core Principles

1. **API First**: Define types in `shared/` package before implementation
2. **TDD**: Write failing tests first, then implement to make them pass
3. **DRY**: Extract reusable code into shared modules
4. **Modular**: Keep services, controllers, and utilities in separate files
5. **Docs as Code**: Update documentation alongside implementation
6. **Type Safety**: Use Zod for runtime validation, TypeScript for static types

## Development Workflow

1. Define types in `shared/src/` package (API contract)
2. Export from `shared/src/index.ts` and run `pnpm --filter @linguistnow/shared build`
3. Write failing tests (TDD red phase)
4. Implement to make tests pass (TDD green phase)
5. Refactor if needed (TDD refactor phase)
6. Add Swagger JSDoc annotations for new API routes
7. Update docs alongside code changes

## Code Organization

| Path                        | Purpose                                    |
| --------------------------- | ------------------------------------------ |
| `shared/src/`               | Types shared between client and server     |
| `server/services/`          | Business logic (testable, reusable)        |
| `server/controllers/`       | HTTP request/response handling             |
| `server/routes/`            | Route definitions with Swagger docs        |
| `server/utils/`             | Server utilities (Vault, token refresh)    |
| `client/src/components/`    | React components                           |
| `client/src/components/ui/` | Radix UI primitives (shadcn/ui pattern)    |
| `client/src/utils/`         | Client utilities                           |
| `client/src/i18n/locales/`  | Internationalization strings               |
| `docs/`                     | Architecture and integration documentation |

---

## Component Patterns

```tsx
// Use named exports, not default exports
export const MyComponent = ({ prop }: Props) => { ... }

// Import shared types from @linguistnow/shared
import { User, ApiResponse } from '@linguistnow/shared'

// Use cn() from lib/utils for conditional classes
import { cn } from '@/lib/utils'
className={cn('base-class', condition && 'conditional-class')}
```

- UI primitives in `client/src/components/ui/` wrap Radix UI
- Use `cva` (class-variance-authority) for variant props

---

## API Patterns

Controllers: validate input FIRST, then business logic, then response.
See `server/controllers/authController.ts` for reference pattern.

Swagger: Add `@openapi` JSDoc above route definitions in `server/routes/*.ts`.

---

## Testing Patterns

| Package | Statements | Branches | Functions | Lines |
| ------- | ---------- | -------- | --------- | ----- |
| Client  | 80%        | 65%      | 75%       | 80%   |
| Server  | 90%        | 75%      | 80%       | 90%   |

Use Arrange-Act-Assert pattern. Mock with `vi.doMock()` before dynamic imports.
See `docs/development/testing-and-tdd.md` for examples.

---

## Internationalization (i18n)

- **All user-facing strings** → `client/src/i18n/locales/*.json`
- **New strings must be added to ALL locales**: en, fr, es, de, it, pt, zh-cn, ja, ko, ar, ru
- Pattern: `section.subsection.key` (e.g., `dashboard.errors.vaultError`)
- Pluralization: `_one` and `_other` suffixes
- Interpolation: `{{variable}}` syntax

---

## Zod Validation

```typescript
import { z } from "zod";

const UserSchema = z.object({
  email: z.string().email().max(254),
  name: z.string().min(1).max(100),
  role: z.enum(["Project Manager", "Linguist"]),
});

const result = UserSchema.safeParse(input);
if (!result.success)
  return res.status(400).json({ error: result.error.message });
```

---

## Security Best Practices

**CRITICAL**: All user input must be validated before use. CodeQL flags unvalidated input.

| Rule                             | Implementation                                         |
| -------------------------------- | ------------------------------------------------------ |
| Validate `req.body/query/params` | Check type, format, bounds before use                  |
| Type validation                  | Validate before `.split()`, `.includes()`, `.map()`    |
| ReDoS prevention                 | Limit input length before regex (email: max 254 chars) |
| Format string injection          | Replace `%` with `%%` in user input for logs           |
| Path traversal                   | Reject paths containing `..`, `/`, `\`                 |
| Formula injection                | Escape `'` → `''` for Airtable formulas                |

---

## Commits & PRs

See [CONTRIBUTING.md](./CONTRIBUTING.md) for full guidelines.

**GitHub CLI**: Always use `gh` CLI for PR operations:

- `gh pr view <number>` - View PR details
- `gh pr checkout <number>` - Checkout PR branch
- `gh pr view <number> --comments` - View PR comments
- `gh api repos/{owner}/{repo}/pulls/{number}/comments` - Get review comments
- `gh run view <run-id> --log-failed` - View failed CI logs

**Commits**: Follow [Conventional Commits](https://www.conventionalcommits.org/).

- `feat:` / `fix:` / `perf:` → trigger releases
- `ci:` / `build:` / `docs:` / `refactor:` / `test:` → no release
- Scopes: `client`, `server`, `shared`, `docker`, `deps`
- Bundle related changes: one commit = one complete feature (code + tests + docs + i18n)

**PRs**: Title follows commit format. Description includes Summary, Changes, How to Test.

- Branch naming: `feature/<issue-id>-<desc>`, `bugfix/<issue-id>-<desc>`
- Keep PRs small (1-15 files ideally)
- Checklist: tests, i18n strings (all 11 locales), no console.log, lint clean

---

## Common Commands

```bash
pnpm dev                                 # Start client + server
pnpm test                                # Run all tests
pnpm --filter ./client test              # Client tests (watch)
pnpm --filter ./server test              # Server tests (watch)
pnpm --filter @linguistnow/shared build  # Build shared types
pnpm lint                                # ESLint all packages
pnpm lint:fix                            # Fix ESLint issues
```

---

## Environment Variables

- **Client**: `client/.env` (template: `client/example.env`)
- **Server**: `server/.env` (template: `server/example.env`)
- Validation via Zod in `*/env.ts` files
