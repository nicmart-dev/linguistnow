# =============================================================================
# LinguistNow - Portainer Stack Configuration (Pre-built Images)
# =============================================================================
# Use this file for deploying pre-built images from GitHub Container Registry.
#
# IMPORTANT: The frontend image has URLs baked in at build time!
# The default pre-built image uses localhost URLs. For production, you must
# either rebuild the frontend locally OR use the GitHub Actions workflow with
# your own secrets configured.
#
# See: docs/deploy-app-to-production.md for detailed instructions.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Server
  # ---------------------------------------------------------------------------
  backend:
    image: ghcr.io/nicmart-dev/linguistnow-backend:latest
    container_name: linguistnow-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5050}:5000"
    environment:
      # Server Configuration
      - PORT=5000
      - NODE_ENV=production
      
      # Frontend URL (for CORS and OAuth redirect validation)
      - FRONTEND_URL=${FRONTEND_URL}
      
      # Google OAuth (Required)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${FRONTEND_URL}
      
      # Airtable Database (Required)
      - AIRTABLE_PERSONAL_ACCESS_TOKEN=${AIRTABLE_PERSONAL_ACCESS_TOKEN}
      - AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}
      
      # n8n Workflow Integration
      - N8N_BASE_URL=${N8N_BASE_URL}
      - N8N_WEBHOOK_PATH=${N8N_WEBHOOK_PATH:-/webhook/calendar-check}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - linguistnow-net

  # ---------------------------------------------------------------------------
  # Frontend Application
  # ---------------------------------------------------------------------------
  # NOTE: The pre-built frontend image has these URLs baked in:
  #   - VITE_API_URL=http://localhost:5000
  #   - VITE_BASE_URL=http://localhost:3000
  #
  # For production with different URLs, you MUST rebuild the frontend.
  # See "Building Frontend with Custom URLs" section below.
  # ---------------------------------------------------------------------------
  frontend:
    image: ghcr.io/nicmart-dev/linguistnow-frontend:latest
    container_name: linguistnow-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3030}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - linguistnow-net

# =============================================================================
# Networks
# =============================================================================
networks:
  linguistnow-net:
    driver: bridge

# =============================================================================
# Building Frontend with Custom URLs
# =============================================================================
# If you need custom URLs (not localhost), replace the frontend service with:
#
#   frontend:
#     build:
#       context: .
#       dockerfile: client/Dockerfile
#       args:
#         - VITE_API_URL=https://api.yourdomain.com
#         - VITE_BASE_URL=https://app.yourdomain.com
#         - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
#     container_name: linguistnow-frontend
#     restart: unless-stopped
#     ports:
#       - "${FRONTEND_PORT:-3030}:80"
#     ...
#
# Or use the full docker-compose.yml which builds from source.
# =============================================================================

