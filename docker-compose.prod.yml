# =============================================================================
# LinguistNow - Production Stack Configuration (Pre-built Images)
# =============================================================================
# PURPOSE: Production deployment with Docker/Portainer
#          Uses pre-built images and connects to existing infrastructure
#
# PREREQUISITES:
#   - shared_net network exists
#   - Vault deployed separately (see docker-compose.vault.yml)
#   - (Optional) n8n for token refresh scheduling
#
# USE THIS FILE WHEN:
#   - Deploying to production with Portainer (any Docker host)
#   - You have shared infrastructure (Vault) already running
#   - You want to use pre-built images from GitHub Container Registry
#
# FOR LOCAL DEVELOPMENT OR SELF-CONTAINED DEPLOYMENTS:
#   Use docker-compose.yml instead (builds from source, includes all services)
#
# IMPORTANT: The frontend image has URLs baked in at build time!
# The default pre-built image uses localhost URLs. For production, you must
# either rebuild the frontend locally OR use the GitHub Actions workflow with
# your own secrets configured.
#
# See: docs/deploy-app-to-production.md for detailed instructions.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Server
  # ---------------------------------------------------------------------------
  backend:
    image: ghcr.io/nicmart-dev/linguistnow-backend:latest
    container_name: linguistnow-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5050}:5000"
    environment:
      # Server Configuration
      - PORT=5000
      - NODE_ENV=production

      # Frontend URL (for CORS and OAuth redirect validation)
      - FRONTEND_URL=${FRONTEND_URL}

      # Backend URL (for Swagger API documentation)
      - BACKEND_URL=${BACKEND_URL}

      # Google OAuth (Required)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${FRONTEND_URL}

      # Airtable Database (Required)
      - AIRTABLE_PERSONAL_ACCESS_TOKEN=${AIRTABLE_PERSONAL_ACCESS_TOKEN}
      - AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}

      # HashiCorp Vault (Required - for token storage)
      - VAULT_ADDR=${VAULT_ADDR:-http://shared-vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_SECRET_PATH=${VAULT_SECRET_PATH:-secret/data/linguistnow/tokens}
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5000/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - shared_net

  # ---------------------------------------------------------------------------
  # Frontend Application
  # ---------------------------------------------------------------------------
  # NOTE: The pre-built frontend image has these URLs baked in:
  #   - VITE_API_URL=http://localhost:5000
  #   - VITE_BASE_URL=http://localhost:3000
  #
  # For production with different URLs, you MUST rebuild the frontend.
  # See "Building Frontend with Custom URLs" section below.
  # ---------------------------------------------------------------------------
  frontend:
    image: ghcr.io/nicmart-dev/linguistnow-frontend:latest
    container_name: linguistnow-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3030}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - shared_net

# =============================================================================
# Networks - Use external shared network for cross-stack communication
# =============================================================================
networks:
  shared_net:
    external: true
    name: shared_net

# =============================================================================
# Required Environment Variables for Portainer
# =============================================================================
# Add these in Portainer's "Environment variables" section:
#
# FRONTEND_URL=https://linguistnow.yourdomain.com
# BACKEND_URL=https://linguistnow-api.yourdomain.com
# GOOGLE_CLIENT_ID=your_google_client_id
# GOOGLE_CLIENT_SECRET=your_google_client_secret
# AIRTABLE_PERSONAL_ACCESS_TOKEN=pat_xxxxx
# AIRTABLE_BASE_ID=appxxxxx
# VAULT_ADDR=http://shared-vault:8200
# VAULT_TOKEN=your_linguistnow_vault_token
#
# =============================================================================
# Building Frontend with Custom URLs
# =============================================================================
# If you need custom URLs (not localhost), replace the frontend service with:
#
#   frontend:
#     build:
#       context: .
#       dockerfile: client/Dockerfile
#       args:
#         - VITE_API_URL=https://api.yourdomain.com
#         - VITE_BASE_URL=https://app.yourdomain.com
#         - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
#     container_name: linguistnow-frontend
#     ...
#
# Or use the full docker-compose.yml which builds from source.
# =============================================================================
