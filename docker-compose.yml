# =============================================================================
# LinguistNow Docker Compose - Full Stack (Build from Source)
# =============================================================================
# PURPOSE: Local development or self-contained deployments
#          Builds all images from source and includes ALL services
#
# INCLUDES: Frontend, Backend, n8n, Vault (everything in one stack)
#
# USE THIS FILE WHEN:
#   - Developing locally
#   - Deploying a fresh, self-contained instance
#   - You want everything running together for simplicity
#
# FOR PRODUCTION WITH SHARED INFRASTRUCTURE:
#   Use these files instead:
#   - docker-compose.vault.yml  → Deploy Vault separately (shared by all apps)
#   - docker-compose.prod.yml   → Deploy LinguistNow (connects to external Vault)
#   - n8n in its own stack      → Configure external secrets to shared Vault
#
# USAGE:
# 1. Copy example.env files and configure your environment:
#    - Root .env for docker-compose variables
#    - server/example.env -> server/.env for local development
#    - client/example.env -> client/.env for local development
#
# 2. Build and run:
#    docker-compose up -d --build
#
# 3. View logs:
#    docker-compose logs -f
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Server (Node.js Express)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: linguistnow-backend:latest
    container_name: linguistnow-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    environment:
      # Server Configuration
      - PORT=5000
      - NODE_ENV=${NODE_ENV:-production}

      # Frontend URL (for CORS and OAuth redirect)
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}

      # Google OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-${FRONTEND_URL:-http://localhost:3000}}

      # Airtable Database Configuration
      - AIRTABLE_PERSONAL_ACCESS_TOKEN=${AIRTABLE_PERSONAL_ACCESS_TOKEN}
      - AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}

      # HashiCorp Vault Configuration
      # Note: Use Docker service name 'vault' for internal network communication
      - VAULT_ADDR=${VAULT_ADDR:-http://vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_SECRET_PATH=${VAULT_SECRET_PATH:-secret/data/linguistnow/tokens}
      # Redis Configuration (for FX rate caching)
      # Note: Use Docker service name 'redis' for internal network communication
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}

      # Frankfurter Configuration (for ECB FX rates)
      # Note: Use Docker service name 'frankfurter' for internal network communication
      - FRANKFURTER_URL=${FRANKFURTER_URL:-http://frankfurter:8080}
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5000/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      vault:
        condition: service_healthy
      redis:
        condition: service_healthy
      frankfurter:
        condition: service_healthy
    networks:
      - linguistnow-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Frontend Application (React + Nginx)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: client/Dockerfile
      args:
        # These are baked into the static files at build time
        # For production, set these to your public-facing URLs
        - VITE_API_URL=${VITE_API_URL:-http://localhost:5000}
        - VITE_BASE_URL=${VITE_BASE_URL:-http://localhost:3000}
        - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID:-${GOOGLE_CLIENT_ID}}
    image: linguistnow-frontend:latest
    container_name: linguistnow-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - linguistnow-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # n8n Workflow Automation
  # ---------------------------------------------------------------------------
  n8n:
    image: n8nio/n8n:latest
    container_name: linguistnow-n8n
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # n8n Configuration
      # WEBHOOK_URL should be the external URL where n8n is accessible
      # For Synology with reverse proxy: https://n8n.yourdomain.com/
      - WEBHOOK_URL=${N8N_EXTERNAL_URL:-http://localhost:5678}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-America/Vancouver}

      # Optional: Basic auth for n8n UI (recommended for production)
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-false}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-}

      # Optional: Disable public API
      - N8N_PUBLIC_API_DISABLED=${N8N_PUBLIC_API_DISABLED:-false}
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5678/healthz",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - linguistnow-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # HashiCorp Vault (Secrets Management)
  # ---------------------------------------------------------------------------
  vault:
    image: hashicorp/vault:latest
    container_name: linguistnow-vault
    restart: unless-stopped
    ports:
      - "${VAULT_PORT:-8200}:8200"
    environment:
      # Development mode (for initial setup/testing)
      # Change to production mode for persistent data
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_DEV_TOKEN:-dev-token}
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      # Production mode settings (uncomment when ready)
      # VAULT_ADDR: "http://0.0.0.0:8200"
      # VAULT_API_ADDR: "http://vault:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-data:/vault/data
      - vault-logs:/vault/logs
      - ./vault/config:/vault/config:ro
    command: server -dev # Change to: server -config=/vault/config for production
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - linguistnow-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Redis (FX Rate Cache)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: linguistnow-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - linguistnow-net

  # ---------------------------------------------------------------------------
  # Frankfurter (ECB FX Rates)
  # ---------------------------------------------------------------------------
  frankfurter:
    image: frankfurter/frankfurter:latest
    container_name: linguistnow-frankfurter
    restart: unless-stopped
    ports:
      - "${FRANKFURTER_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/latest"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - linguistnow-net

# =============================================================================
# Networks
# =============================================================================
networks:
  linguistnow-net:
    driver: bridge
    name: linguistnow-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  n8n_data:
    name: linguistnow-n8n-data
  vault-data:
    name: linguistnow-vault-data
  vault-logs:
    name: linguistnow-vault-logs
  redis-data:
    name: linguistnow-redis-data